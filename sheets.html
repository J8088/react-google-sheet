<!DOCTYPE html>
<html>

<head>
  <title>Google Sheets API Quickstart</title>
  <meta charset='utf-8' />
  <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="https://unpkg.com/react-broadcast@0.7.0-rc.2/umd/react-broadcast.min.js"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.onload = resolve
        script.onerror = reject
        script.async = true
        script.src = url
        document.head.appendChild(script)
      })
    }

    const { createContext } = ReactBroadcast

    const { Provider: GoogleAPIProvider, Consumer: GoogleApiConsumer } = createContext(null);

    class GoogleAPI extends React.Component {
      state = {
        signedIn: false,
        client: null,
        loading: true
      }

      componentDidMount() {
        this.setupApi()
      }

      async setupApi() {
        if (typeof window.gapi === 'undefined') {
          await loadScript('https://apis.google.com/js/api.js')
        }
        if (!gapi.client) {
          await new Promise(resolve => gapi.load('client:auth2', resolve));
        }
        await gapi.client.init({
          apiKey: this.props.apiKey,
          clientId: this.props.clientId,
          discoveryDocs: this.props.discoveryDocs,
          scope: this.props.scopes.join(',')
        })
        this.auth = gapi.auth2.getAuthInstance()
        this.setState({
          client: gapi.client,
          loading: false,
          signedIn: this.auth.isSignedIn.get()
        })
        // Listen for sign-in state changes.
        this.auth.isSignedIn.listen(signedIn => this.setState({ signedIn }));
      }

      authorize = () => {
        if (this.auth) {
          this.auth.signIn()
        }
      }

      signout = () => {
        if (this.auth) {
          this.auth.signOut()
        }
      }

      render() {
        return (
          <GoogleAPIProvider value={this.state.client}>
          {
            this.props.children({
              client: this.state.client,
              signedIn: this.state.signedIn,
              authorize: this.authorize,
              signout: this.signout,
              loading: this.state.loading
            })
          }
          </GoogleAPIProvider>
        );
      }

    }

    class GoogleSheet extends React.Component {
      state = {
        error: null,
        values: null,
        loading: false
      }

      componentDidMount() {
        this.load()
      }

      load = async () => {
        this.setState({ loading: true })
        // TODO get from context
        try {
          const response = await this.props.client.sheets.spreadsheets.values.get({
            spreadsheetId: this.props.id,
            range: this.props.range
          })
          this.setState({ loading: false, values: response.result.values  })
        } catch (response) {
          this.setState({ loading: false, error: response.result.error })
        }
      }

      render() {
        return this.props.children({
          error: this.state.error,
          values: this.state.values,
          loading: this.state.loading,
          load: this.load,
         })
      }
    }

    const App = () => {
      const CLIENT_ID = '377437361891-v0ib2hve7mupdcpsibtuqr35o2h61op9.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyCmxlWlcNnx6oWgMrSLAkYzOEa3efiMDtY';

      // Array of API discovery doc URLs for APIs used by the quickstart
      const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

      // Authorization scopes required by the API; multiple scopes can be
      // included, separated by spaces.
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";
      const spreadsheetId = '1_rkdEgDc8ZktKB7ZLIT1H8-xKSneKWNuHqF0On9Ng-E'
      const range = 'Crayfish!2:12'

      return (
        <GoogleAPI clientId={CLIENT_ID} apiKey={API_KEY} scopes={[SCOPES]} discoveryDocs={DISCOVERY_DOCS}>
          {({ authorize, loading: apiLoading, signout, signedIn }) => (
            <div>
              <p>Google Sheets API Quickstart</p>
              {!apiLoading && !signedIn && <button onClick={authorize}>Authorize</button>}
              {signedIn && <button onClick={signout}>Sign Out</button>}
              <GoogleApiConsumer>
                {client => (
                  signedIn &&
                    <GoogleSheet client={client} id={spreadsheetId} range={range}>
                      {({ error, values, loading, fetch }) => (
                        <pre>
                          {values && JSON.stringify(values, null, 2)}
                          {error && JSON.stringify(error.message, null, 2)}
                        </pre>
                      )}
                    </GoogleSheet>
                )}
              </GoogleApiConsumer>
            </div>
          )}
        </GoogleAPI>
      )
    }

    ReactDOM.render(
      <App/>,
      document.getElementById('root')
    );

  </script>
</body>

</html>