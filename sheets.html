<!DOCTYPE html>
<html>

<head>
  <title>Google Sheets API Quickstart</title>
  <meta charset='utf-8' />
  <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  <script src="https://unpkg.com/react-broadcast@0.7.0-rc.2/umd/react-broadcast.min.js"></script>
  <script src="https://unpkg.com/lodash@4.17.4/lodash.min.js"></script>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.onload = resolve
        script.onerror = reject
        script.async = true
        script.src = url
        document.head.appendChild(script)
      })
    }

    function assert(condition, msg = `Invariant ${condition} not met`) {
      if (!condition) {
        throw new Error(msg)
      }
    }

    const { createContext } = ReactBroadcast
    const { memoize, zipObject } = _

    const { Provider: GoogleApiProvider, Consumer: GoogleApiConsumer } = createContext(null);
    GoogleApiProvider.displayName = 'GoogleApiProvider'
    GoogleApiConsumer.displayName = 'GoogleApiConsumer'

    class GoogleAPI extends React.Component {
      state = {
        signedIn: false,
        client: null,
        loading: true,
        authorize: this.authorize,
        signout: this.signout
      }

      componentDidMount() {
        this.setupApi()
      }

      // TODO cancellation?
      async setupApi() {
        if (typeof window.gapi === 'undefined') {
          // TODO better error message if this fails
          await loadScript('https://apis.google.com/js/api.js')
        }
        if (!gapi.client) {
          // TODO check if this callback can have an error and handle better
          await new Promise(resolve => gapi.load('client:auth2', resolve));
        }
        await gapi.client.init({
          apiKey: this.props.apiKey,
          clientId: this.props.clientId,
          discoveryDocs: this.props.discoveryDocs,
          scope: this.props.scopes.join(',')
        })
        this.auth = gapi.auth2.getAuthInstance()
        this.setState({
          client: gapi.client,
          loading: false,
          signedIn: this.auth.isSignedIn.get()
        })
        // Listen for sign-in state changes.
        this.auth.isSignedIn.listen(signedIn => this.setState({ signedIn }));
      }

      authorize = () => {
        if (this.auth) {
          this.auth.signIn()
        }
      }

      signout = () => {
        if (this.auth) {
          this.auth.signOut()
        }
      }

      render() {
        return (
          <GoogleApiProvider value={this.state}>
            {this.props.children(this.state)}
          </GoogleApiProvider>
        );
      }

    }

    class GSheetData extends React.Component {
      state = {
        error: null,
        data: null,
        loading: false
      }

      componentDidMount() {
        this.fetch()
      }

      componentDidUpdate(prevProps, prevState) {
        if (prevProps.id !== this.props.id || prevProps.range !== this.props.range) {
          this.fetch()
        }
      }

      fetch = async () => {
        this.setState({ loading: true })
        assert(
          this.props.api,
          `Google API client should be setup & authenticated with GoogleApiProvider before it's used in ${this.constructor.name}`
        )
        try {
          const params = {
            spreadsheetId: this.props.id,
            range: this.props.range
          }
          const response = await this.props.api.client.sheets.spreadsheets.values.get(params)
          // Unable to cancel requests, so we wait until it's done and check it's still the desired one
          if (this.props.id == params.spreadsheetId && this.props.range == params.range) {
            this.setState({ loading: false, data: response.result.values  })
          }
        } catch (response) {
          this.setState({ loading: false, error: response.result.error })
        }
      }

      render() {
        return this.props.children({
          error: this.state.error,
          data: this.state.data,
          loading: this.state.loading,
          refetch: this.fetch
         })
      }
    }

    const GSheet = props => (
      <GoogleApiConsumer>
        {api => <GSheetData api={api} {...props} />}
      </GoogleApiConsumer>
    )

    let objectify = data => {
      let labels = data[0]
      labels[0] = 'number'
      return data.slice(1).map(row => zipObject(labels, row))
    }
    memoize.Cache = WeakMap
    objectify = memoize(objectify)

    const Blob = ({ data }) =>
      <pre>
        {JSON.stringify(objectify(data), null, 2)}
      </pre>

    const Table = ({ data }) =>
      <table>
        <thead>
          <tr>
            {data[0].map((label, i) => <th key={i}>{label}</th>)}
          </tr>
        </thead>
        <tbody>
          {data.slice(1).map((row, i) =>
            <tr key={i}>
              {row.map((cell, j) => <td key={j}>{cell}</td>)}
            </tr>
          )}
        </tbody>
      </table>

    const RenderChoices = {
      table: Table,
      blob: Blob,
    }

    const MyData = ({ data, render }) => {
      const Comp = RenderChoices[render]
      return <Comp data={data} />
    }

    const MySpreadsheet = (props) => {
      return (
        <GSheet id={props.id} range={props.range}>
          {({ error, data, loading, refetch }) => (
            loading
              ? "Getting data..."
              : data
                ? <MyData data={data} render={props.render}/>
                : error
                  ? JSON.stringify(error.message, null, 2)
                  : null
          )}
        </GSheet>
      );
    }

    class DynamicSpreadsheet extends React.Component {
      state = {
        id: '1_rkdEgDc8ZktKB7ZLIT1H8-xKSneKWNuHqF0On9Ng-E',
        range: 'Crayfish!2:12',
        render: "table",
        submitted: null
      }

      handleSubmit = event => {
        event.preventDefault();
        this.setState({
          submitted: {
            id: this.state.id,
            range: this.state.range
          }
        })
      }

      handleIdChange = event => this.setState({ id: event.target.value })
      handleRangeChange = event => this.setState({ range: event.target.value })
      handleRenderChange = event => this.setState({ render: event.target.value })

      render() {
        return (
          <div>
            <form onSubmit={this.handleSubmit}>
              <input placeholder="Spreadsheet ID" onChange={this.handleIdChange} value={this.state.id}/>
              <input placeholder="Range" onChange={this.handleRangeChange} value={this.state.range} />
              <select value={this.state.render} onChange={this.handleRenderChange}>
                {Object.keys(RenderChoices).map(key =>
                  <option value={key} key={key}>{key}</option>
                )}
              </select>
              <input type="submit" value="Submit" />
            </form>
            {this.state.submitted &&
              <MySpreadsheet
                id={this.state.submitted.id}
                range={this.state.submitted.range}
                render={this.state.render}
              />
            }
          </div>
        )
      }
    }

    const App = () => {
      const CLIENT_ID = '377437361891-v0ib2hve7mupdcpsibtuqr35o2h61op9.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyCmxlWlcNnx6oWgMrSLAkYzOEa3efiMDtY';

      // Array of API discovery doc URLs for APIs used by the quickstart
      const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

      // Authorization scopes required by the API
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly";

      return (
        <GoogleAPI clientId={CLIENT_ID} apiKey={API_KEY} scopes={[SCOPES]} discoveryDocs={DISCOVERY_DOCS}>
          {({ authorize, loading: apiLoading, signout, signedIn }) => (
            <div>
              <p>Google Sheets API Quickstart</p>
              {apiLoading && "Loading..."}
              {!apiLoading && !signedIn && <button onClick={authorize}>Authorize</button>}
              {signedIn && <button onClick={signout}>Sign Out</button>}
              {signedIn && <DynamicSpreadsheet />}
            </div>
          )}
        </GoogleAPI>
      )
    }

    ReactDOM.render(
      <App/>,
      document.getElementById('root')
    );

  </script>
</body>

</html>